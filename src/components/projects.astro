---
import { Image } from "astro:assets";
import ProjectCard from "@/components/project_card.astro";

import MCC from "../../public/halo_MCC.png";
import BelowAndBeyond from "../../public/surviving_mars.png";
import DungeonLogo from "../../public/endless_dungeon.png";
import Confidential from "../../public/unreleased_shooter.png";
import PortalSII from "../../public/portal_sii.png";

import Endless1 from "../../public/endless_1.png"
import Endless2 from "../../public/endless_2.png"
import MCC1 from "../../public/mcc_1.png"
import MCC2 from "../../public/mcc_2.png"
import MCC3 from "../../public/mcc_3.png"
import Suma1 from "../../public/suma_1.png"
import Suma2 from "../../public/suma_2.png"
import Portal1 from "../../public/portal_1.PNG"
import Portal2 from "../../public/portal_2.PNG"
import Portal3 from "../../public/portal_3.PNG"
import Portal4 from "../../public/portal_4.PNG"

import TwinStones from "../../public/twin_stones.png";
import AtlasEngine from "../../public/atlas_engine.png";

interface ProjectSection 
{
  sectionImportance: number;
  sectionTitle: string;
  sectionDescription: string;
}

interface Project {
  title: string;
  image: ImageMetadata;
  id: string;
  preview: string;
  status: string;
  description: ProjectSection[];
  gallery: ImageMetadata[];
  personal?: boolean;
}

const projects: Project[] = [
  {
    title: "Halo: The Master Chief Collection",
    image: MCC as ImageMetadata,
    id: "halo_mcc",
    preview: "https://abstraction.games/game/halo-the-master-chief-collection",
    status: "abstraction games",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "Co development project to enhance and upgrade Halo: The Master Chief Collection with accesibility features across multiple platforms."
      },
      {
        sectionImportance: 2,
        sectionTitle: "My work",
        sectionDescription:
          "Delivered multiple accesibility features, integrated and compatible with all the different games (and game engines): customizable subtitles, controller remapping, resizable and reorganizable HUD. \n Also, I was in charge of adding an upgraded navpoint system to better guide new players across the different titles."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "C++, HaloScript, Perforce, UE4, Blam"
      }
    ],
    gallery: [
      MCC1 as ImageMetadata,
      MCC2 as ImageMetadata,
      MCC3 as ImageMetadata,
    ]
  },
  {
    title: "The Endless Dungeon",
    image: DungeonLogo as ImageMetadata,
    id: "endless_dungeon",
    preview: "https://youtu.be/MlQApTnDdLU",
    status: "abstraction games",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "Abstraction games was in charge of porting the game to multiple consoles."
      },
      {
        sectionImportance: 2,
        sectionTitle: "My work",
        sectionDescription:
          "I mostly helped with cooperative bugfixing on consoles and platform specific features implementation, such as friends list, invitations, lobbies, etc."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "Unity, C#, Xbox GDK, PlayStation SDK, online services"
      }
    ],
    gallery: [
      Endless1 as ImageMetadata,
      Endless2 as ImageMetadata,
    ]
  },
  {
    title: "Surviving Mars: Below & Beyond",
    image: BelowAndBeyond as ImageMetadata,
    id: "suma",
    preview: "https://abstraction.games/game/survivingmars",
    status: "abstraction games",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "This was my first professional project in the industry. I joined the team in charge of the DLC at a later stage of the development cycle."
      },
      {
        sectionImportance: 2,
        sectionTitle: "My work",
        sectionDescription:
          "I worked on adding some new buildings required by the new DLC mechanics. When it was released, I helped tackling multiple bugs and optimization fixes."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "C++, Lua, Git, Visual Studio"
      }
    ],
    gallery: [
      Suma1 as ImageMetadata,
      Suma2 as ImageMetadata,
    ]
  },
  {
    title: "Unreleased AAA first person shooter",
    image: Confidential as ImageMetadata,
    id: "aaa_fps",
    preview: "empty",
    status: "abstraction games",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "This project was a codevelopment project. I was part of the engine team developing a custom Unreal Engine solution to support the project needs. I cannot go into much detail yet."
      },
      {
        sectionImportance: 2,
        sectionTitle: "My work",
        sectionDescription:
          "Developed a custom plugin for UE5. Also helped with the creation of a new object pipeline to author assets. Other important point was a customization of Unreal's enhanced input."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "UE5, Custom Engines, Perforce, C++, Scripting"
      }
    ],
    gallery: []
  },
  {
    title: "Portal SII",
    image: PortalSII as ImageMetadata,
    id: "portal_sii",
    preview: "empty",
    status: "AHORA freeware",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "I worked for this company during my Bachelor's degree internship. I was tasked with the creation of a web portal integrated with the Spanish tax services API to manage the access of different companies to their tax data."
      },
      {
        sectionImportance: 2,
        sectionTitle: "My work",
        sectionDescription:
          "I had an old API wrote in Visual Basic. I was tasked to update it with new tech and create the frontend so it can be accessed online. I took care of everything, from the design to the refactor of the API, both frontend and backend. This work served me as my final degree project and I was able to learn React and Entity Framework during the development."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "React, .NET Core, Entity Framework, Agile methodologies"
      }
    ],
    gallery: [
      Portal1 as ImageMetadata,
      Portal2 as ImageMetadata,
      Portal3 as ImageMetadata,
      Portal4 as ImageMetadata,
    ]
  },
  {
    title: "Twin Stones",
    image: TwinStones as ImageMetadata,
    id: "twin_stones",
    preview: "https://youtu.be/ekIfO7PDAhE",
    status: "ESAT",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "Worked as part of a multidisciplinary team maintaining and extending Halo: The Master Chief Collection across multiple platforms."
      },
      {
        sectionImportance: 2,
        sectionTitle: "Responsibilities",
        sectionDescription:
          "Gameplay bug fixing, performance optimization, platform-specific fixes, and cross-discipline collaboration."
      },
      {
        sectionImportance: 3,
        sectionTitle: "Technical Focus",
        sectionDescription:
          "Engine-level debugging, legacy system refactoring, and console certification compliance."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "C++, proprietary engine tools, Perforce, internal debugging and profiling tools."
      }
    ],
    gallery: [
      TwinStones as ImageMetadata,
      TwinStones as ImageMetadata,
    ],
    personal: true
  },
  {
    title: "Atlas Engine",
    image: AtlasEngine as ImageMetadata,
    id: "atlas_engine",
    preview: "https://youtu.be/jQECz8RYhtQ",
    status: "ESAT",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "Worked as part of a multidisciplinary team maintaining and extending Halo: The Master Chief Collection across multiple platforms."
      },
      {
        sectionImportance: 2,
        sectionTitle: "Responsibilities",
        sectionDescription:
          "Gameplay bug fixing, performance optimization, platform-specific fixes, and cross-discipline collaboration."
      },
      {
        sectionImportance: 3,
        sectionTitle: "Technical Focus",
        sectionDescription:
          "Engine-level debugging, legacy system refactoring, and console certification compliance."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "C++, proprietary engine tools, Perforce, internal debugging and profiling tools."
      }
    ],
    gallery: [
      AtlasEngine as ImageMetadata,
      AtlasEngine as ImageMetadata,
    ],
    personal: true
  },
];
---

<section
  id="professional_projects"
  class="py-12 border-t border-[#ffffff10] text-[var(--white)]"
>
  <div class="max-w-5xl mx-auto">
    <h2 class="text-lg text-[var(--sec)] mb-2 shiny-sec">Work produced as part of a company</h2>
    <h3 class="text-4xl md:text-5xl font-medium mb-8">Industry Experience</h3> 

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      {
        projects.filter(p => !p.personal).map((project) => (
          <ProjectCard project={project} />
        ))
      }
    </div>
  </div>
</section>

<section
  id="personal_projects"
  class="py-12 border-t border-[#ffffff10] text-[var(--white)]"
>
  <div class="max-w-5xl mx-auto">
    <h2 class="text-lg text-[var(--sec)] mb-2 shiny-sec">Personal explorations and student work</h2>
    <h3 class="text-4xl md:text-5xl font-medium mb-8">Independent & Academic Project</h3> 

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      {
        projects.filter(p => p.personal).map((project) => (
          <ProjectCard project={project} />
        ))
      }
    </div>
  </div>
</section>

  <!-- Modal Backdrop -->
<div
  id="project-modal-backdrop"
  class="fixed inset-0 z-40 hidden bg-black/60 backdrop-blur-sm"
></div>
<!-- Modal -->
<div
  id="project-modal"
  class="fixed z-50 top-1/2 left-1/2 w-[90vw] max-w-4xl
         -translate-x-1/2 -translate-y-1/2
         bg-[#141414] border border-[#ffffff10]
         rounded-2xl shadow-2xl
         origin-top
         scale-y-0 opacity-0
         transition-all duration-500 ease-[cubic-bezier(.4,0,.2,1)]"
>
  <!-- Close Button -->
  <button
    id="project-modal-close"
    class="absolute top-4 right-4 text-gray-400 hover:text-white transition"
    aria-label="Close"
  >
    ✕
  </button>

  <!-- Content -->
  <div class="p-6 md:p-10 space-y-6 max-h-[80vh] overflow-y-auto">
    <!-- Injected via JS -->
  </div>
</div>

<div id="projects-data-container" data-projects={JSON.stringify(projects)} hidden></div>

<style>
  .modal-open {
    opacity: 1 !important;
    transform: translate(-50%, -50%) scaleY(1) !important;
  }

  .modal-closed {
    opacity: 0;
    transform: translate(-50%, -50%) scaleY(0);
  }

  #project-modal,
  #project-modal .modal-scroll {
    color: var(--white);
  }

  #project-modal h4,
  #project-modal h5,
  #project-modal p,
  #project-modal a {
    color: inherit; /* ensures all text uses modal color */
  }

  .modal-carousel::-webkit-scrollbar {
  height: 8px;
  }
  .modal-carousel::-webkit-scrollbar-track {
    background: transparent;
  }
  .modal-carousel::-webkit-scrollbar-thumb {
    background-color: rgba(255,255,255,0.2);
    border-radius: 999px;
  }
  .modal-carousel::-webkit-scrollbar-thumb:hover {
    background-color: rgba(255,255,255,0.35);
  }
  
  /* Make carousel hide overflow visually on small screens */
  .modal-carousel {
    -webkit-overflow-scrolling: touch;
  }

    /* Divider animation */
  @keyframes grow {
    to {
      transform: scaleX(1);
    }
  }
</style>

<script>
  let activeProjectId = null;
  
  const projectsContainer = document.getElementById('projects-data-container');
  const projects = JSON.parse(projectsContainer.dataset.projects || '[]');
  
  const modal = document.getElementById('project-modal');
  const backdrop = document.getElementById('project-modal-backdrop');
  const modalContent = modal.querySelector('div');
  const closeBtn = document.getElementById('project-modal-close');
  
  // Close modal helper
  function closeModal() {
    modal.classList.remove('modal-open');
    modal.classList.add('modal-closed');
    backdrop.classList.add('hidden');
    activeProjectId = null;
  
    document
      .querySelectorAll('.toggle-btn')
      .forEach(b => b.classList.remove('rotate-180'));
  }
  
  // Click backdrop to close
  backdrop.addEventListener('click', closeModal);
  closeBtn.addEventListener('click', closeModal);

  function getSectionHeadingClass(importance) {
  switch (importance) {
    case 1:
      return "text-2xl md:text-3xl font-semibold";
    case 2:
      return "text-xl md:text-2xl font-semibold";
    case 3:
      return "text-lg md:text-xl font-medium";
    case 4:
    default:
      return "text-lg font-medium uppercase tracking-wide text-gray-400";
  }
}

  (window as any).toggleProject = function (projectId, btn) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // If already open → close
  if (activeProjectId === projectId) {
    closeModal();
    return;
  }

modalContent.innerHTML = `
  <h4 class="text-4xl font-semibold mb-8">${project.title}</h4>

  <div
  class="w-full h-px mb-8
         bg-gradient-to-r from-transparent via-[#ffffff30] to-transparent
         scale-x-0 origin-center
         animate-[grow_0.5s_ease-out_forwards]"
         animation-delay-[350ms]">
  </div>

  ${project.description
    .sort((a, b) => a.sectionImportance - b.sectionImportance)
  .map(section => {
    if (section.sectionImportance === 4) {
      // Split by comma and trim spaces
      const tools = section.sectionDescription.split(',').map(t => t.trim());
      return `
        <section class="mb-6">
          <h5 class="${getSectionHeadingClass(section.sectionImportance)} mb-2">
            ${section.sectionTitle}
          </h5>
          <div class="flex flex-wrap gap-2">
            ${tools.map(tool => `
              <span class="px-3 py-1 bg-[#2a2a2a] text-white rounded-full text-sm">
                ${tool}
              </span>
            `).join('')}
          </div>
        </section>
      `;
    } else {
      // Normal section
      return `
        <section class="mb-6">
          <h5 class="${getSectionHeadingClass(section.sectionImportance)} mb-2">
            ${section.sectionTitle}
          </h5>
          <p class="text-gray-300 leading-relaxed">
            ${section.sectionDescription}
          </p>
        </section>
      `;
    }
  }).join('')
  }

  ${
    project.gallery?.length
      ? `
    <div class="modal-carousel flex overflow-x-auto scroll-smooth snap-x snap-mandatory space-x-4 mt-8 pb-4">
      ${project.gallery.map(img => `
      <div class="snap-start flex-shrink-0 w-80 sm:w-96 md:w-[28rem] lg:w-[32rem]">
        <img src="${img.src ?? img}" alt="${project.title} screenshot"
           class="rounded-xl object-cover w-full h-64" />
      </div>
      `).join('')}
    </div>
  `
      : ''
  }

  ${
    project.preview && project.preview !== "empty"
      ? `
    <div class="pt-6">
      <a
        href="${project.preview}"
        target="_blank"
        class="inline-flex items-center gap-2 text-[var(--sec)] hover:underline"
      >
        View Project →
      </a>
    </div>
  `
      : ''
  }
`;

  backdrop.classList.remove('hidden');

  // Force reflow so animation always plays
  modal.classList.remove('modal-closed');
  modal.offsetHeight;
  modal.classList.add('modal-open');

  document
    .querySelectorAll('.toggle-btn')
    .forEach(b => b.classList.remove('rotate-180'));

  btn.classList.add('rotate-180');
  activeProjectId = projectId;
  };
</script>
