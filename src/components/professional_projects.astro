---
import { Image } from "astro:assets";
import ProjectCard from "@/components/project_card.astro";

import MCC from "../../public/halo_MCC.png";
import BelowAndBeyond from "../../public/surviving_mars.png";
import DungeonLogo from "../../public/endless_dungeon.png";
import Confidential from "../../public/unreleased_shooter.png";
import PortalSII from "../../public/portal_sii.png";

interface ProjectSection 
{
  sectionImportance: number;
  sectionTitle: string;
  sectionDescription: string;
}

interface Project {
  title: string;
  image: ImageMetadata;
  id: string;
  preview: string;
  status: string;
  description: ProjectSection[];
  gallery: ImageMetadata[];
}

const projects: Project[] = [
  {
    title: "Halo: The Master Chief Collection",
    image: MCC as ImageMetadata,
    id: "halo_mcc",
    preview: "https://abstraction.games/game/halo-the-master-chief-collection",
    status: "abstraction games",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "Worked as part of a multidisciplinary team maintaining and extending Halo: The Master Chief Collection across multiple platforms."
      },
      {
        sectionImportance: 2,
        sectionTitle: "Responsibilities",
        sectionDescription:
          "Gameplay bug fixing, performance optimization, platform-specific fixes, and cross-discipline collaboration."
      },
      {
        sectionImportance: 3,
        sectionTitle: "Technical Focus",
        sectionDescription:
          "Engine-level debugging, legacy system refactoring, and console certification compliance."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "C++, proprietary engine tools, Perforce, internal debugging and profiling tools."
      }
    ],
    gallery: [
      MCC as ImageMetadata,
      MCC as ImageMetadata,
    ]
  },
  {
    title: "The Endless Dungeon",
    image: DungeonLogo as ImageMetadata,
    id: "endless_dungeon",
    preview: "https://youtu.be/MlQApTnDdLU",
    status: "abstraction games",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "Worked as part of a multidisciplinary team maintaining and extending Halo: The Master Chief Collection across multiple platforms."
      },
      {
        sectionImportance: 2,
        sectionTitle: "Responsibilities",
        sectionDescription:
          "Gameplay bug fixing, performance optimization, platform-specific fixes, and cross-discipline collaboration."
      },
      {
        sectionImportance: 3,
        sectionTitle: "Technical Focus",
        sectionDescription:
          "Engine-level debugging, legacy system refactoring, and console certification compliance."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "C++, proprietary engine tools, Perforce, internal debugging and profiling tools."
      }
    ],
    gallery: [
      MCC as ImageMetadata,
      MCC as ImageMetadata,
    ]
  },
  {
    title: "Surviving Mars: Below & Beyond",
    image: BelowAndBeyond as ImageMetadata,
    id: "suma",
    preview: "https://abstraction.games/game/survivingmars",
    status: "abstraction games",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "Worked as part of a multidisciplinary team maintaining and extending Halo: The Master Chief Collection across multiple platforms."
      },
      {
        sectionImportance: 2,
        sectionTitle: "Responsibilities",
        sectionDescription:
          "Gameplay bug fixing, performance optimization, platform-specific fixes, and cross-discipline collaboration."
      },
      {
        sectionImportance: 3,
        sectionTitle: "Technical Focus",
        sectionDescription:
          "Engine-level debugging, legacy system refactoring, and console certification compliance."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "C++, proprietary engine tools, Perforce, internal debugging and profiling tools."
      }
    ],
    gallery: [
      MCC as ImageMetadata,
      MCC as ImageMetadata,
    ]
  },
  {
    title: "Unreleased AAA first person shooter",
    image: Confidential as ImageMetadata,
    id: "aaa_fps",
    preview: "empty",
    status: "abstraction games",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "Worked as part of a multidisciplinary team maintaining and extending Halo: The Master Chief Collection across multiple platforms."
      },
      {
        sectionImportance: 2,
        sectionTitle: "Responsibilities",
        sectionDescription:
          "Gameplay bug fixing, performance optimization, platform-specific fixes, and cross-discipline collaboration."
      },
      {
        sectionImportance: 3,
        sectionTitle: "Technical Focus",
        sectionDescription:
          "Engine-level debugging, legacy system refactoring, and console certification compliance."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "C++, proprietary engine tools, Perforce, internal debugging and profiling tools."
      }
    ],
    gallery: [
      MCC as ImageMetadata,
      MCC as ImageMetadata,
    ]
  },
  {
    title: "Portal SII",
    image: PortalSII as ImageMetadata,
    id: "portal_sii",
    preview: "empty",
    status: "AHORA freeware",
    description: [
      {
        sectionImportance: 1,
        sectionTitle: "Overview",
        sectionDescription:
          "Worked as part of a multidisciplinary team maintaining and extending Halo: The Master Chief Collection across multiple platforms."
      },
      {
        sectionImportance: 2,
        sectionTitle: "Responsibilities",
        sectionDescription:
          "Gameplay bug fixing, performance optimization, platform-specific fixes, and cross-discipline collaboration."
      },
      {
        sectionImportance: 3,
        sectionTitle: "Technical Focus",
        sectionDescription:
          "Engine-level debugging, legacy system refactoring, and console certification compliance."
      },
      {
        sectionImportance: 4,
        sectionTitle: "Tools & Technologies",
        sectionDescription:
          "C++, proprietary engine tools, Perforce, internal debugging and profiling tools."
      }
    ],
    gallery: [
      MCC as ImageMetadata,
      MCC as ImageMetadata,
    ]
  },
];
---

<section
  id="professional_projects"
  class="py-12 border-t border-[#ffffff10] text-[var(--white)]"
>
  <div class="max-w-5xl mx-auto">
    <h2 class="text-lg text-[var(--sec)] mb-2 shiny-sec">Work produced as part of a company</h2>
    <h3 class="text-4xl md:text-5xl font-medium mb-8">Industry Experience</h3> 

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      {
        projects.map((project) => (
          <ProjectCard project={project} />
        ))
      }
    </div>

    <!-- Modal Backdrop -->
    <div
      id="project-modal-backdrop"
      class="fixed inset-0 z-40 hidden bg-black/60 backdrop-blur-sm"
    ></div>

    <!-- Modal -->
    <div
      id="project-modal"
      class="fixed z-50 top-1/2 left-1/2 w-[90vw] max-w-4xl
             -translate-x-1/2 -translate-y-1/2
             bg-[#141414] border border-[#ffffff10]
             rounded-2xl shadow-2xl
             origin-top
             scale-y-0 opacity-0
             transition-all duration-500 ease-[cubic-bezier(.4,0,.2,1)]"
    >
      <!-- Close Button -->
      <button
        id="project-modal-close"
        class="absolute top-4 right-4 text-gray-400 hover:text-white transition"
        aria-label="Close"
      >
        ✕
      </button>
    
      <!-- Content -->
      <div class="p-6 md:p-10 space-y-6 max-h-[80vh] overflow-y-auto">
        <!-- Injected via JS -->
      </div>
    </div>

  </div>

  <div id="projects-data-container" data-projects={JSON.stringify(projects)} hidden></div>

</section>

<style>
  .modal-open {
    opacity: 1 !important;
    transform: translate(-50%, -50%) scaleY(1) !important;
  }

  .modal-closed {
    opacity: 0;
    transform: translate(-50%, -50%) scaleY(0);
  }

    /* Divider animation */
  @keyframes grow {
    to {
      transform: scaleX(1);
    }
  }
</style>

<script>
  let activeProjectId = null;
  
  const projectsContainer = document.getElementById('projects-data-container');
  const projects = JSON.parse(projectsContainer.dataset.projects || '[]');
  
  const modal = document.getElementById('project-modal');
  const backdrop = document.getElementById('project-modal-backdrop');
  const modalContent = modal.querySelector('div');
  const closeBtn = document.getElementById('project-modal-close');
  
  // Close modal helper
  function closeModal() {
    modal.classList.remove('modal-open');
    modal.classList.add('modal-closed');
    backdrop.classList.add('hidden');
    activeProjectId = null;
  
    document
      .querySelectorAll('.toggle-btn')
      .forEach(b => b.classList.remove('rotate-180'));
  }
  
  // Click backdrop to close
  backdrop.addEventListener('click', closeModal);
  closeBtn.addEventListener('click', closeModal);

  function getSectionHeadingClass(importance) {
  switch (importance) {
    case 1:
      return "text-2xl md:text-3xl font-semibold";
    case 2:
      return "text-xl md:text-2xl font-semibold";
    case 3:
      return "text-lg md:text-xl font-medium";
    case 4:
    default:
      return "text-lg font-medium uppercase tracking-wide text-gray-400";
  }
}

  (window as any).toggleProject = function (projectId, btn) {
  const project = projects.find(p => p.id === projectId);
  if (!project) return;

  // If already open → close
  if (activeProjectId === projectId) {
    closeModal();
    return;
  }

modalContent.innerHTML = `
  <h4 class="text-4xl font-semibold mb-8">${project.title}</h4>

  <div
  class="w-full h-px mb-8
         bg-gradient-to-r from-transparent via-[#ffffff30] to-transparent
         scale-x-0 origin-center
         animate-[grow_0.5s_ease-out_forwards]"
         animation-delay-[350ms]">
  </div>

  ${project.description
    .sort((a, b) => a.sectionImportance - b.sectionImportance)
    .map(section => `
      <section class="mb-6">
        <h5 class="${getSectionHeadingClass(section.sectionImportance)} mb-2">
          ${section.sectionTitle}
        </h5>
        <p class="text-gray-300 leading-relaxed">
          ${section.sectionDescription}
        </p>
      </section>
    `)
    .join('')
  }

  ${
    project.gallery?.length
      ? `
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-8">
      ${project.gallery.map(img => `
        <img
          src="${img.src ?? img}"
          alt="${project.title} screenshot"
          class="rounded-xl object-cover w-full h-64"
        />
      `).join('')}
    </div>
  `
      : ''
  }

  ${
    project.preview && project.preview !== "empty"
      ? `
    <div class="pt-6">
      <a
        href="${project.preview}"
        target="_blank"
        class="inline-flex items-center gap-2 text-[var(--sec)] hover:underline"
      >
        View Project →
      </a>
    </div>
  `
      : ''
  }
`;

  backdrop.classList.remove('hidden');

  // Force reflow so animation always plays
  modal.classList.remove('modal-closed');
  modal.offsetHeight;
  modal.classList.add('modal-open');

  document
    .querySelectorAll('.toggle-btn')
    .forEach(b => b.classList.remove('rotate-180'));

  btn.classList.add('rotate-180');
  activeProjectId = projectId;
  };
</script>
